syntax = "proto3";

option go_package = "github.com/ehsaniara/joblet-proto/v2/gen";

package joblet;

// Main service for running jobs
service JobService {
  // Job operations
  rpc RunJob(RunJobRequest) returns (RunJobResponse){}
  rpc GetJobStatus(GetJobStatusRequest) returns (GetJobStatusResponse){}
  rpc StopJob(StopJobRequest) returns (StopJobResponse){}
  rpc CancelJob(CancelJobRequest) returns (CancelJobResponse){}
  rpc DeleteJob(DeleteJobRequest) returns (DeleteJobResponse){}
  rpc DeleteAllJobs(DeleteAllJobsRequest) returns (DeleteAllJobsResponse){}
  rpc GetJobLogs(GetJobLogsRequest) returns (stream DataChunk);
  rpc ListJobs(EmptyRequest) returns (Jobs){}

  // Job Metrics (resource usage from cgroups - sampled every 5s)
  // Stream live metrics for a running job
  rpc StreamJobMetrics(StreamJobMetricsRequest) returns (stream JobMetricsEvent){}
  // Get historical metrics for a completed job
  rpc GetJobMetrics(GetJobMetricsRequest) returns (stream JobMetricsEvent){}

  // Job Telematics (eBPF security events - event-driven)
  // Stream live telematics events for a running job
  rpc StreamJobTelematics(StreamJobTelematicsRequest) returns (stream TelematicsEvent){}
  // Get historical telematics events for a completed job
  rpc GetJobTelematics(GetJobTelematicsRequest) returns (stream TelematicsEvent){}
}

// Network service
service NetworkService {
  rpc CreateNetwork(CreateNetworkRequest) returns (CreateNetworkResponse){}
  rpc ListNetworks(EmptyRequest) returns (Networks){}
  rpc RemoveNetwork(RemoveNetworkRequest) returns (RemoveNetworkResponse){}
}

// Volume service
service VolumeService {
  rpc CreateVolume(CreateVolumeRequest) returns (CreateVolumeResponse){}
  rpc ListVolumes(EmptyRequest) returns (Volumes){}
  rpc RemoveVolume(RemoveVolumeRequest) returns (RemoveVolumeResponse){}
}

// Monitoring service
service MonitoringService {
  rpc GetSystemStatus(EmptyRequest) returns (SystemStatusResponse){}
  rpc StreamSystemMetrics(StreamMetricsRequest) returns (stream SystemMetricsResponse){}
}

// Runtime service for managing execution environments
service RuntimeService {
  rpc ListRuntimes(EmptyRequest) returns (ListRuntimesResponse){}
  rpc GetRuntimeInfo(GetRuntimeInfoRequest) returns (GetRuntimeInfoResponse){}
  rpc TestRuntime(TestRuntimeRequest) returns (TestRuntimeResponse){}
  rpc RemoveRuntime(RemoveRuntimeRequest) returns (RemoveRuntimeResponse){}

  // BuildRuntime builds a runtime from a YAML specification
  // The build process runs on the server and streams progress back to the client
  rpc BuildRuntime(BuildRuntimeRequest) returns (stream BuildRuntimeProgress){}

  // ValidateRuntimeYAML validates a runtime YAML specification without building
  rpc ValidateRuntimeYAML(ValidateRuntimeYAMLRequest) returns (ValidateRuntimeYAMLResponse){}
}

message Jobs{
  repeated Job jobs = 1;
}

message Job{
  string uuid = 1;                         // Job UUID
  string command = 3;
  repeated string args = 4;
  int32 max_cpu = 5;
  string cpu_cores = 6;
  int32 max_memory = 7;
  int32 max_io_bps = 8;
  string status = 9;
  string start_time = 10;
  string end_time = 11;
  int32 exit_code = 12;
  string scheduled_time = 13;    // Schedule time (RFC3339, empty = immediate)
  string runtime = 14;          // Runtime spec
  map<string, string> environment = 15;       // Environment variables
  map<string, string> secret_environment = 16; // Secret env vars (masked in logs)

  // GPU fields
  repeated int32 gpu_indices = 17;         // Which GPUs allocated
  int32 gpu_count = 18;                    // Number of GPUs requested/allocated
  int32 gpu_memory_mb = 19;                // GPU memory requirement (MB)

  // Node identification
  string node_id = 20;                      // Unique identifier of the Joblet node that executed this job
}

message EmptyRequest {}

message FileUpload {
  string path = 1;           // Path in workspace
  bytes content = 2;         // Content
  uint32 mode = 3;           // Unix permissions
  bool is_directory = 4;      // Is directory
}

// GetJobStatus
message GetJobStatusRequest{
  string uuid = 1;                         // Job UUID identifier
}

message GetJobStatusResponse{
  string uuid = 1;                         // Job UUID identifier
  string command = 3;
  repeated string args = 4;
  int32 max_cpu = 5;
  string cpu_cores = 6;
  int32 max_memory = 7;
  int32 max_io_bps = 8;
  string status = 9;
  string start_time = 10;
  string end_time = 11;
  int32 exit_code = 12;
  string scheduled_time = 13;    // When the job should execute (empty if immediate)
  map<string, string> environment = 14;       // Regular environment variables (visible)
  map<string, string> secret_environment = 15; // Secret environment variables (masked)
  string network = 16;                     // Network configuration
  repeated string volumes = 17;            // Mounted volumes
  string runtime = 18;                     // Runtime environment
  string work_dir = 19;                     // Working directory
  repeated string uploads = 20;            // Uploaded files/directories

  // GPU allocation info
  repeated int32 gpu_indices = 23;         // Which GPUs allocated to this job
  int32 gpu_count = 24;                    // Number of GPUs requested/allocated
  int32 gpu_memory_mb = 25;                // GPU memory requirement (MB)

  // Node identification
  string node_id = 26;                      // Unique identifier of the Joblet node that executed this job
}

// StopJob
message StopJobRequest{
  string uuid = 1;                         // Job UUID identifier
}

message StopJobResponse{
  string uuid = 1;                         // Job UUID identifier
  string status = 2;
  string end_time = 3;
  int32 exit_code = 4;
}

// CancelJob - for canceling scheduled jobs only
message CancelJobRequest{
  string uuid = 1;                         // Job UUID identifier
}

message CancelJobResponse{
  string uuid = 1;                         // Job UUID identifier
  string status = 2;                       // Should be "CANCELED"
}

// DeleteJob
message DeleteJobRequest{
  string uuid = 1;                         // Job UUID identifier
}

message DeleteJobResponse{
  string uuid = 1;                         // Job UUID identifier
  bool success = 2;
  string message = 3;
}

// DeleteAllJobs
message DeleteAllJobsRequest{
  // Empty - deletes all non-running jobs
}

message DeleteAllJobsResponse{
  bool success = 1;
  string message = 2;
  int32 deleted_count = 3;                 // Jobs deleted
  int32 skipped_count = 4;                 // Jobs skipped (still running)
}

// GetJobLogs
message GetJobLogsRequest{
  string uuid = 1;                         // Job UUID identifier
}

message DataChunk {
  bytes payload = 1;
}

// BuildRuntime messages

message BuildRuntimeRequest {
  string yaml_content = 1;         // YAML specification content
  bool dry_run = 2;                // If true, validate only without building
  bool verbose = 3;                // If true, include detailed logs
  bool force_rebuild = 4;          // If true, rebuild even if runtime exists
}

message BuildRuntimeProgress {
  oneof progress_type {
    BuildPhaseProgress phase = 1;
    BuildLogLine log = 2;
    BuildResult result = 3;
  }
}

message BuildPhaseProgress {
  int32 phase_number = 1;          // Current phase (1-14)
  int32 total_phases = 2;          // Total phases (14)
  string phase_name = 3;           // e.g., "Installing system packages"
  string message = 4;              // Progress message
}

message BuildLogLine {
  string level = 1;                // "debug", "info", "warn", "error"
  string message = 2;              // Log message
  int64 timestamp = 3;             // Unix timestamp in nanoseconds
}

message BuildResult {
  bool success = 1;                // Build succeeded
  string message = 2;              // Final message
  string runtime_name = 3;         // Runtime name (e.g., "python-3.11-ml")
  string runtime_version = 4;      // Runtime version
  string install_path = 5;         // Path where runtime was installed
  int64 size_bytes = 6;            // Total size of the runtime
  int64 build_duration_ms = 7;     // Build duration in milliseconds
}

// ValidateRuntimeYAML messages

message ValidateRuntimeYAMLRequest {
  string yaml_content = 1;         // YAML specification content
}

message ValidateRuntimeYAMLResponse {
  bool valid = 1;                  // Is the YAML valid
  string message = 2;              // Validation message
  repeated string errors = 3;      // List of validation errors
  repeated string warnings = 4;    // List of warnings
  RuntimeYAMLInfo spec_info = 5;   // Parsed spec info (if valid)
}

message RuntimeYAMLInfo {
  string name = 1;                 // Runtime name
  string version = 2;              // Version
  string language = 3;             // Language (python, java, node, etc.)
  string language_version = 4;     // Language version (e.g., "3.11")
  string description = 5;          // Description
  repeated string pip_packages = 6;   // Pip packages to install
  repeated string npm_packages = 7;   // NPM packages to install
  bool has_hooks = 8;              // Has pre/post install hooks
  bool requires_gpu = 9;           // Requires GPU
}

message CreateNetworkRequest {
  string name = 1;
  string cidr = 2;
}

message CreateNetworkResponse {
  string name = 1;
  string cidr = 2;
  string bridge = 3;
}

message RemoveNetworkRequest {
  string name = 1;
}

message RemoveNetworkResponse {
  bool success = 1;
  string message = 2;
}

message Network {
  string name = 1;
  string cidr = 2;
  string bridge = 3;
  int32 job_count = 4;
}

message Networks {
  repeated Network networks = 1;
}

message CreateVolumeRequest {
  string name = 1;
  string size = 2;        // Size (e.g., "1GB", "500MB")
  string type = 3;        // Type: filesystem or memory
}

message CreateVolumeResponse {
  string name = 1;
  string size = 2;
  string type = 3;
  string path = 4;        // Host path
}

message RemoveVolumeRequest {
  string name = 1;
}

message RemoveVolumeResponse {
  bool success = 1;
  string message = 2;
}

message Volume {
  string name = 1;
  string size = 2;
  string type = 3;
  string path = 4;
  string created_time = 5;
  int32 job_count = 6;     // Jobs using this volume
}

message Volumes {
  repeated Volume volumes = 1;
}

// System monitoring messages

message SystemStatusResponse {
  string timestamp = 1;
  bool available = 2;
  HostInfo host = 3;
  CPUMetrics cpu = 4;
  MemoryMetrics memory = 5;
  repeated DiskMetrics disks = 6;
  repeated NetworkMetrics networks = 7;
  IOMetrics io = 8;
  ProcessMetrics processes = 9;
  CloudInfo cloud = 10;
  ServerVersionInfo server_version = 11;
}

message SystemMetricsResponse {
  string timestamp = 1;
  HostInfo host = 2;
  CPUMetrics cpu = 3;
  MemoryMetrics memory = 4;
  repeated DiskMetrics disks = 5;
  repeated NetworkMetrics networks = 6;
  IOMetrics io = 7;
  ProcessMetrics processes = 8;
  CloudInfo cloud = 9;
}

message StreamMetricsRequest {
  int32 interval_seconds = 1; // How often to send updates (default: 5)
  repeated string metric_types = 2; // Optional: filter by types
}

// Monitoring data structures

message HostInfo {
  string hostname = 1;
  string os = 2;
  string kernel_version = 6;
  string architecture = 8;
  string boot_time = 11;
  int64 uptime = 12;
  string node_id = 13;                  // Unique node identifier (UUID)
  repeated string server_ips = 14;      // Server IP addresses (can have multiple interfaces)
  repeated string mac_addresses = 15;   // MAC addresses for network interfaces
}

message CPUMetrics {
  int32 cores = 1;
  double usage_percent = 2;
  double user_time = 3;
  double system_time = 4;
  double idle_time = 5;
  double io_wait_time = 6;
  double steal_time = 7;
  repeated double load_average = 8; // 1, 5, 15 min load
  repeated double per_core_usage = 9;
}

message MemoryMetrics {
  int64 total_bytes = 1;
  int64 used_bytes = 2;
  int64 free_bytes = 3;
  int64 available_bytes = 4;
  double usage_percent = 5;
  int64 cached_bytes = 6;
  int64 buffered_bytes = 7;
  int64 swap_total = 8;
  int64 swap_used = 9;
  int64 swap_free = 10;
}

message DiskMetrics {
  string device = 1;
  string mount_point = 2;
  string filesystem = 3;
  int64 total_bytes = 4;
  int64 used_bytes = 5;
  int64 free_bytes = 6;
  double usage_percent = 7;
  int64 inodes_total = 8;
  int64 inodes_used = 9;
  int64 inodes_free = 10;
  double inodes_usage_percent = 11;
}

message NetworkMetrics {
  string interface = 1;
  int64 bytes_received = 2;
  int64 bytes_sent = 3;
  int64 packets_received = 4;
  int64 packets_sent = 5;
  int64 errors_in = 6;
  int64 errors_out = 7;
  int64 drops_in = 8;
  int64 drops_out = 9;
  double receive_rate = 10; // bytes/sec
  double transmit_rate = 11; // bytes/sec
  repeated string ip_addresses = 12; // IP addresses assigned to this interface (e.g., ["192.168.1.10", "fe80::1"])
  string mac_address = 13; // Hardware MAC address (e.g., "00:1a:2b:3c:4d:5e")
}

message IOMetrics {
  int64 total_reads = 1;
  int64 total_writes = 2;
  int64 read_bytes = 3;
  int64 write_bytes = 4;
  double read_rate = 5;  // bytes/sec
  double write_rate = 6; // bytes/sec
  repeated DiskIOMetrics disk_io = 7;
}

message DiskIOMetrics {
  string device = 1;
  int64 reads_completed = 2;
  int64 writes_completed = 3;
  int64 read_bytes = 4;
  int64 write_bytes = 5;
  int64 read_time = 6;  // ms
  int64 write_time = 7; // ms
  int64 io_time = 8;    // ms
  double utilization = 9; // percent
}


message ProcessMetrics {
  int32 total_processes = 1;
  int32 running_processes = 2;
  int32 sleeping_processes = 3;
  int32 stopped_processes = 4;
  int32 zombie_processes = 5;
  int32 total_threads = 6;
  repeated ProcessInfo top_by_cpu = 7;
  repeated ProcessInfo top_by_memory = 8;
}

message ProcessInfo {
  int32 pid = 1;
  int32 ppid = 2;
  string name = 3;
  string command = 4;
  double cpu_percent = 5;
  double memory_percent = 6;
  int64 memory_bytes = 7;
  string status = 8;
  string start_time = 9;
}

message CloudInfo {
  string provider = 1;
  string region = 2;
  string zone = 3;
  string instance_id = 4;
  string instance_type = 5;
  string hypervisor_type = 6;
  map<string, string> metadata = 7;
}

message ServerVersionInfo {
  string version = 1;        // Version (e.g., "v1.2.3")
  string git_commit = 2;     // Git commit
  string git_tag = 3;        // Git tag
  string build_date = 4;     // Build date
  string component = 5;      // Component ("joblet")
  string go_version = 6;     // Go version
  string platform = 7;       // OS/arch (e.g., "linux/amd64")
  string proto_commit = 8;   // Proto repository commit hash
  string proto_tag = 9;      // Proto repository tag
}

// Runtime management messages
message ListRuntimesResponse {
  repeated RuntimeInfo runtimes = 1;
}

message RuntimeInfo {
  string name = 1;                  // Runtime name (e.g., "python-3.11-ml")
  string language = 2;              // Language (e.g., "python")
  string version = 3;               // Runtime version (e.g., "1.0.0")
  string description = 4;           // Description
  int64 size_bytes = 5;              // Size in bytes
  repeated string packages = 6;     // Installed packages (pip, npm, etc.)
  bool available = 7;               // Ready to use
  RuntimeRequirements requirements = 8;
  string language_version = 9;      // Language version (e.g., "3.11" for Python)
  repeated string libraries = 10;   // Library patterns copied (e.g., "libopenblas*")
  map<string, string> environment = 11; // Environment variables
  RuntimeBuildInfo build_info = 12; // Build metadata
  string original_yaml = 13;        // Original runtime.yaml content (for display)
}

message RuntimeBuildInfo {
  string built_at = 1;              // When built (RFC3339)
  string built_with = 2;            // Builder version
  string platform = 3;              // Platform (e.g., "ubuntu-amd64")
}

message RuntimeRequirements {
  repeated string architectures = 1; // Supported archs
  bool gpu = 2;                      // Needs GPU
}

message GetRuntimeInfoRequest {
  string runtime = 1;               // e.g., "python-3.11-ml"
}

message GetRuntimeInfoResponse {
  RuntimeInfo runtime = 1;
  bool found = 2;
}

message TestRuntimeRequest {
  string runtime = 1;               // e.g., "python-3.11-ml"
}

message TestRuntimeResponse {
  bool success = 2;
  string output = 3;
  string error = 4;
  int32 exit_code = 5;
}

// Job messages

message RunJobRequest {
  string command = 2;
  repeated string args = 3;
  int32 max_cpu = 4;
  string cpu_cores = 5;
  int32 max_memory = 6;
  int32 max_io_bps = 7;
  repeated FileUpload uploads = 8;
  string schedule = 9;
  string network = 10;
  repeated string volumes = 11;
  string runtime = 12;
  string work_dir = 13;
  map<string, string> environment = 14;
  map<string, string> secret_environment = 18; // Secret env vars

  // GPU fields
  int32 gpu_count = 19;             // How many GPUs requested
  int32 gpu_memory_mb = 20;         // Minimum GPU memory needed (MB)
}

message RunJobResponse {
  string job_uuid = 1;               // Job UUID identifier
  string status = 2;                 // Job status (RUNNING, SCHEDULED, etc.)
}

message Timestamp {
  int64 seconds = 1;
  int32 nanos = 2;
}


message RemoveRuntimeRequest {
  string runtime = 1;              // Runtime to remove
}

message RemoveRuntimeResponse {
  bool success = 1;                // Success
  string message = 2;              // Message
  int64 freed_space_bytes = 3;       // Space freed
}

// =============================================================================
// Job Metrics Messages (Resource Usage - Time-based Sampling)
// =============================================================================

// Request to stream live metrics for a running job
message StreamJobMetricsRequest {
  string job_uuid = 1;             // Job UUID identifier
}

// Request to get historical metrics for a completed job
message GetJobMetricsRequest {
  string job_uuid = 1;             // Job UUID identifier
  int64 start_time = 2;            // Start time in Unix nanoseconds (0 = beginning)
  int64 end_time = 3;              // End time in Unix nanoseconds (0 = now)
  int32 limit = 4;                 // Maximum events to return (0 = no limit)
}

// Job metrics event (resource usage from cgroups v2)
message JobMetricsEvent {
  int64 timestamp = 1;             // Unix timestamp in nanoseconds
  string job_uuid = 2;               // Job UUID
  double cpu_percent = 3;          // CPU usage percentage
  int64 memory_bytes = 4;          // Current memory usage in bytes
  int64 memory_limit = 5;          // Memory limit in bytes
  int64 disk_read_bytes = 6;       // Total disk bytes read
  int64 disk_write_bytes = 7;      // Total disk bytes written
  int64 net_recv_bytes = 8;        // Total network bytes received
  int64 net_sent_bytes = 9;        // Total network bytes sent
  double gpu_percent = 10;         // GPU utilization percentage (0 if no GPU)
  int64 gpu_memory_bytes = 11;     // GPU memory usage in bytes (0 if no GPU)
}

// =============================================================================
// Job Telematics Messages (eBPF Security Events - Event-driven)
// =============================================================================

// Request to stream live telematics events for a running job
message StreamJobTelematicsRequest {
  string job_uuid = 1;             // Job UUID identifier
  repeated string types = 2;       // Filter by types: ["exec", "connect", "accept", "file", "mmap", "mprotect"] or empty for all
}

// Request to get historical telematics events for a completed job
message GetJobTelematicsRequest {
  string job_uuid = 1;             // Job UUID identifier
  repeated string types = 2;       // Filter by types: ["exec", "connect", "accept", "file", "mmap", "mprotect"] or empty for all
  int64 start_time = 3;            // Start time in Unix nanoseconds (0 = beginning)
  int64 end_time = 4;              // End time in Unix nanoseconds (0 = now)
  int32 limit = 5;                 // Maximum events to return (0 = no limit)
}

// Telematics event from eBPF tracing
message TelematicsEvent {
  int64 timestamp = 1;             // Unix timestamp in nanoseconds
  string job_uuid = 2;               // Job UUID
  string type = 3;                 // Event type: "exec", "connect", "accept", "file", "mmap", "mprotect"

  oneof data {
    TelematicsExecData exec = 10;
    TelematicsConnectData connect = 11;
    TelematicsAcceptData accept = 12;
    TelematicsFileData file = 13;
    TelematicsMmapData mmap = 14;
    TelematicsMprotectData mprotect = 15;
    TelematicsSocketDataData socket_data = 16;
  }
}

// Process execution event (execve syscall)
message TelematicsExecData {
  uint32 pid = 1;                  // Process ID
  uint32 ppid = 2;                 // Parent process ID
  string binary = 3;               // Binary path (e.g., "/usr/bin/python")
  repeated string args = 4;        // Command arguments
  int32 exit_code = 5;             // Exit code (only set on process exit)
}

// Outgoing network connection event (connect syscall)
message TelematicsConnectData {
  uint32 pid = 1;                  // Process ID that initiated connection
  string dst_addr = 2;             // Destination IP address (IPv4 or IPv6)
  uint32 dst_port = 3;             // Destination port number
  string protocol = 4;             // Protocol: "tcp" or "udp"
  string src_addr = 5;             // Source IP address
  uint32 src_port = 6;             // Source port number
}

// Incoming connection accept event (accept syscall)
message TelematicsAcceptData {
  uint32 pid = 1;                  // Server process ID
  string src_addr = 2;             // Client IP address
  uint32 src_port = 3;             // Client port
  string dst_addr = 4;             // Server IP address
  uint32 dst_port = 5;             // Server port (listening port)
  string protocol = 6;             // Protocol: "tcp"
}

// File access event (open/read/write syscalls)
message TelematicsFileData {
  uint32 pid = 1;                  // Process ID
  string path = 2;                 // File path
  string operation = 3;            // Operation: "open", "read", "write", "create", "delete"
  int64 bytes = 4;                 // Bytes read/written (if applicable)
  uint32 flags = 5;                // Open flags
}

// Memory mapping event (mmap syscall)
message TelematicsMmapData {
  uint32 pid = 1;                  // Process ID
  uint64 addr = 2;                 // Mapped address
  uint64 length = 3;               // Mapping length
  uint32 prot = 4;                 // Protection flags (PROT_READ|PROT_WRITE|PROT_EXEC)
  uint32 flags = 5;                // Mapping flags (MAP_SHARED|MAP_PRIVATE|etc)
  string file_path = 6;            // File path if file-backed mapping
}

// Memory protection change event (mprotect syscall)
message TelematicsMprotectData {
  uint32 pid = 1;                  // Process ID
  uint64 addr = 2;                 // Start address
  uint64 length = 3;               // Length of region
  uint32 prot = 4;                 // New protection flags
}

// Socket data event (sendto/recvfrom syscalls)
message TelematicsSocketDataData {
  uint32 pid = 1;                  // Process ID
  string direction = 2;            // "send" or "recv"
  string dst_addr = 3;             // Remote address
  uint32 dst_port = 4;             // Remote port
  string src_addr = 5;             // Local address
  uint32 src_port = 6;             // Local port
  string protocol = 7;             // Protocol: "tcp" or "udp"
  int64 bytes = 8;                 // Bytes sent/received
}
